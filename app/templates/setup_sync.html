{% extends "base.html" %}

{% block title %}{{ config.get_page_title('Channel Sync') }}{% endblock %}

{% block content %}
<div class="flex flex-col">
    <div class="max-w-6xl mx-auto px-12 w-full">
        
        <!-- Page Header -->
        <div class="mb-8 mt-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-gradient-to-br from-green-600 to-emerald-600 rounded-full flex items-center justify-center mr-4 shadow-lg">
                        <i class="fas fa-sync-alt text-xl text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-white mb-1">
                            Channel Sync
                        </h1>
                        <p class="text-gray-300">
                            Import and update channels from your DVR server
                        </p>
                    </div>
                </div>
                <a href="/setup" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Setup
                </a>
            </div>
        </div>

        <!-- Sync Options -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <!-- Update Channels -->
            <div class="bg-gradient-to-br from-blue-800/40 to-blue-900/60 backdrop-blur-xl border border-blue-600/30 rounded-xl shadow-lg">
                <div class="p-8">
                    <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg">
                        <i class="fas fa-sync-alt text-white text-2xl"></i>
                    </div>
                    <h3 class="text-2xl font-semibold text-white text-center mb-4">Update Channels</h3>
                    <p class="text-blue-200 text-center mb-6">Add new channels and update existing ones while preserving your enabled/disabled preferences.</p>
                    
                    <div class="bg-blue-600/10 border border-blue-500/30 rounded-lg p-4 mb-6">
                        <div class="flex items-start">
                            <i class="fas fa-info-circle text-blue-400 mr-3 mt-0.5"></i>
                            <div class="text-sm text-blue-200">
                                <strong>Safe Update:</strong> This will add new channels from your DVR and update existing channel information, but won't remove channels or reset your preferences.
                            </div>
                        </div>
                    </div>
                    
                    <button id="updateChannelsBtn" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 disabled:from-gray-600 disabled:to-gray-700 text-white px-6 py-3 rounded-lg text-lg font-semibold transition-all duration-200 shadow-lg shadow-blue-600/20">
                        <i id="updateChannelsIcon" class="fas fa-sync-alt mr-2"></i>
                        <span id="updateChannelsText">Update Channels</span>
                    </button>
                </div>
            </div>

            <!-- Re-sync All -->
            <div class="bg-gradient-to-br from-red-800/40 to-red-900/60 backdrop-blur-xl border border-red-600/30 rounded-xl shadow-lg">
                <div class="p-8">
                    <div class="w-16 h-16 bg-gradient-to-br from-red-500 to-red-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg">
                        <i class="fas fa-redo text-white text-2xl"></i>
                    </div>
                    <h3 class="text-2xl font-semibold text-white text-center mb-4">Re-sync All</h3>
                    <p class="text-red-200 text-center mb-6">Completely rebuild your channel list from scratch. This will reset all preferences.</p>
                    
                    <div class="bg-red-600/10 border border-red-500/30 rounded-lg p-4 mb-6">
                        <div class="flex items-start">
                            <i class="fas fa-exclamation-triangle text-red-400 mr-3 mt-0.5"></i>
                            <div class="text-sm text-red-200">
                                <strong>⚠️ Warning:</strong> This will remove channels no longer on your DVR and reset ALL enabled/disabled preferences. This action cannot be undone.
                            </div>
                        </div>
                    </div>
                    
                    <button id="resyncAllBtn" class="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 disabled:from-gray-600 disabled:to-gray-700 text-white px-6 py-3 rounded-lg text-lg font-semibold transition-all duration-200 shadow-lg shadow-red-600/20">
                        <i class="fas fa-redo mr-2"></i>
                        Re-sync All
                    </button>
                </div>
            </div>
        </div>

        <!-- Current Stats -->
        {% if channel_stats %}
        <div class="bg-gradient-to-br from-gray-800/40 to-gray-900/60 backdrop-blur-xl border border-gray-600/30 rounded-xl mb-8 shadow-lg">
            <div class="p-6 border-b border-gray-700/30">
                <h3 class="text-xl font-semibold text-white flex items-center">
                    <i class="fas fa-chart-bar mr-3 text-purple-400"></i>
                    Current Channel Statistics
                </h3>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-blue-400 mb-1">{{ channel_stats.total_channels }}</div>
                        <div class="text-gray-400 text-sm">Total Channels</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-green-400 mb-1">{{ channel_stats.enabled_channels }}</div>
                        <div class="text-gray-400 text-sm">Enabled</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-red-400 mb-1">{{ channel_stats.disabled_channels }}</div>
                        <div class="text-gray-400 text-sm">Disabled</div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Sync Status -->
        <div id="syncStatus" class="p-6 rounded-xl hidden mb-8">
            <div id="syncStatusContent" class="flex items-center mb-4">
                <i id="syncStatusIcon" class="fas mr-3 text-xl"></i>
                <span id="syncStatusMessage" class="text-lg font-semibold"></span>
            </div>
            <div id="syncStatusDetails" class="text-gray-300 hidden">
                <span id="syncStatusDetailsText"></span>
            </div>
        </div>

        <!-- Server Status Check -->
        {% if dvr_status == 'offline' %}
        <div class="bg-gradient-to-r from-yellow-800/30 to-orange-800/30 backdrop-blur-xl border border-yellow-600/30 rounded-xl shadow-lg">
            <div class="p-6">
                <div class="flex items-center mb-4">
                    <i class="fas fa-exclamation-triangle text-yellow-400 mr-3 text-xl"></i>
                    <h3 class="text-xl font-semibold text-white">DVR Server Offline</h3>
                </div>
                <div class="text-yellow-200 mb-4">
                    <p>Cannot sync channels because your Channels DVR server is not accessible. Please ensure your server is running and try again.</p>
                </div>
                <button onclick="location.reload()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-3 rounded-lg font-medium transition-all duration-200">
                    <i class="fas fa-refresh mr-2"></i>Check Connection
                </button>
            </div>
        </div>
        {% endif %}

        <script>
        class ChannelSyncManager {
            constructor() {
                this.syncing = false;
                this.syncResult = null;
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
            }
            
            setupEventListeners() {
                document.getElementById('updateChannelsBtn').addEventListener('click', () => {
                    this.syncChannels(false);
                });
                
                document.getElementById('resyncAllBtn').addEventListener('click', () => {
                    this.confirmResyncAll();
                });
            }
            
            confirmResyncAll() {
                const message = "⚠️ DANGER: Re-sync All will:\n\n" +
                              "• Remove channels no longer on your DVR server\n" +
                              "• Reset ALL channel enabled/disabled preferences\n" +
                              "• Remove all custom channel settings\n" +
                              "• Completely rebuild your channel database\n\n" +
                              "This action CANNOT be undone.\n\n" +
                              "Are you absolutely sure you want to continue?";
                
                if (confirm(message)) {
                    // Double confirmation for destructive action
                    const secondConfirm = confirm("This is your final warning. This will permanently delete all your channel preferences.\n\nType 'YES' in the next dialog to confirm.");
                    if (secondConfirm) {
                        const finalConfirm = prompt("Type 'YES' to confirm the complete reset of all channel data:");
                        if (finalConfirm === 'YES') {
                            this.syncChannels(true);
                        } else {
                            alert('Re-sync cancelled. Your channel data is safe.');
                        }
                    }
                }
            }
            
            async syncChannels(replaceExisting = false) {
                this.syncing = true;
                this.syncResult = null;
                this.updateSyncUI();
                
                try {
                    const response = await fetch('/api/channels/sync', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            replace_existing: replaceExisting
                        })
                    });
                    
                    const result = await response.json();
                    this.syncResult = result;
                    this.updateSyncUI();
                    
                    if (result.success) {
                        // Reload page to get updated stats
                        setTimeout(() => {
                            window.location.reload();
                        }, 3000);
                    }
                    
                } catch (error) {
                    this.syncResult = {
                        success: false,
                        error: 'Network error: ' + error.message
                    };
                    this.updateSyncUI();
                } finally {
                    this.syncing = false;
                    setTimeout(() => {
                        this.updateSyncUI();
                    }, 5000);
                }
            }
            
            updateSyncUI() {
                const updateBtn = document.getElementById('updateChannelsBtn');
                const resyncBtn = document.getElementById('resyncAllBtn');
                const updateIcon = document.getElementById('updateChannelsIcon');
                const updateText = document.getElementById('updateChannelsText');
                const syncStatus = document.getElementById('syncStatus');
                const syncStatusContent = document.getElementById('syncStatusContent');
                const syncStatusIcon = document.getElementById('syncStatusIcon');
                const syncStatusMessage = document.getElementById('syncStatusMessage');
                const syncStatusDetails = document.getElementById('syncStatusDetails');
                const syncStatusDetailsText = document.getElementById('syncStatusDetailsText');
                
                // Update button states
                updateBtn.disabled = this.syncing;
                resyncBtn.disabled = this.syncing;
                
                // Update icon and text
                if (this.syncing) {
                    updateIcon.classList.add('animate-spin');
                    updateText.textContent = 'Syncing...';
                } else {
                    updateIcon.classList.remove('animate-spin');
                    updateText.textContent = 'Update Channels';
                }
                
                // Update sync status
                if (this.syncResult) {
                    syncStatus.classList.remove('hidden');
                    
                    if (this.syncResult.success) {
                        syncStatus.className = 'p-6 rounded-xl bg-green-600/20 border border-green-500/30 mb-8';
                        syncStatusContent.className = 'flex items-center mb-4 text-green-400';
                        syncStatusIcon.className = 'fas fa-check-circle mr-3 text-xl';
                        syncStatusMessage.textContent = 'Sync completed successfully!';
                        syncStatusDetails.classList.remove('hidden');
                        syncStatusDetailsText.textContent = `Processed: ${this.syncResult.channels_processed} channels | Added: ${this.syncResult.channels_added} | Updated: ${this.syncResult.channels_updated}`;
                        
                        if (this.syncResult.channels_removed > 0) {
                            syncStatusDetailsText.textContent += ` | Removed: ${this.syncResult.channels_removed}`;
                        }
                    } else {
                        syncStatus.className = 'p-6 rounded-xl bg-red-600/20 border border-red-500/30 mb-8';
                        syncStatusContent.className = 'flex items-center mb-4 text-red-400';
                        syncStatusIcon.className = 'fas fa-exclamation-circle mr-3 text-xl';
                        syncStatusMessage.textContent = 'Sync failed!';
                        syncStatusDetails.classList.remove('hidden');
                        syncStatusDetailsText.textContent = 'Error: ' + this.syncResult.error;
                    }
                } else {
                    syncStatus.classList.add('hidden');
                }
            }
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Only initialize if DVR is online
            {% if dvr_status == 'online' %}
            window.syncManager = new ChannelSyncManager();
            {% endif %}
        });
        </script>

    </div>
</div>
{% endblock %}
