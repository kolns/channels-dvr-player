{% extends "base.html" %}

{% block title %}{{ config.get_page_title('playlist') }}{% endblock %}

{% block content %}
<div id="playlistApp" class="flex flex-col">
    <div class="max-w-7xl mx-auto px-12 w-full pb-12">
        
        <!-- Page Title -->
        <div class="mb-8 mt-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-gradient-to-br from-purple-600 to-purple-700 rounded-full flex items-center justify-center mr-4 shadow-lg">
                        <i class="fas fa-heart text-xl text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-white mb-1">
                            Playlist Builder
                        </h1>
                        <p class="text-gray-300">
                            Create and manage custom channel playlists
                        </p>
                    </div>
                </div>
                
                <!-- Create New Playlist Button -->
                <button id="createPlaylistBtn" class="bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white px-6 py-3 rounded-lg font-medium transition-all duration-200 shadow-lg shadow-purple-600/20">
                    <i class="fas fa-plus mr-2"></i>
                    Create Playlist
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Sidebar - Playlists -->
            <div class="lg:col-span-1">
                <div class="bg-gradient-to-br from-gray-800/40 to-gray-900/60 backdrop-blur-xl border border-gray-600/30 rounded-2xl shadow-2xl shadow-gray-900/50">
                    
                    <!-- Playlists Header -->
                    <div class="p-6 border-b border-gray-700/50">
                        <div class="flex items-center justify-between">
                            <h2 class="text-xl font-semibold text-white">My Playlists</h2>
                            <span id="playlistCount" class="text-sm text-gray-400">0 playlists</span>
                        </div>
                    </div>
                    
                    <!-- Playlists List -->
                    <div class="p-4 max-h-96 overflow-y-auto">
                        <div id="playlistsList">
                            <!-- Playlists will be populated by JavaScript -->
                        </div>
                        
                        <!-- Empty State -->
                        <div id="playlistsEmptyState" class="text-center py-8 text-gray-400 hidden">
                            <i class="fas fa-list text-3xl mb-4"></i>
                            <p class="text-sm">No playlists yet</p>
                            <p class="text-xs mt-1">Create your first playlist to get started</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Content - Channel Selection & Playlist Editor -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Channel Browser -->
                <div class="bg-gradient-to-br from-gray-800/40 to-gray-900/60 backdrop-blur-xl border border-gray-600/30 rounded-2xl shadow-2xl shadow-gray-900/50">
                    
                    <!-- Channel Browser Header -->
                    <div class="p-6 border-b border-gray-700/50">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-semibold text-white">Available Channels</h2>
                            <span id="availableChannelsCount" class="text-sm text-gray-400">0 channels</span>
                        </div>
                        
                        <!-- Search and Filter -->
                        <div class="flex gap-4">
                            <div class="flex-1 relative">
                                <input type="text" 
                                       id="channelSearch"
                                       placeholder="Search channels..."
                                       class="w-full bg-gray-800/50 border border-gray-700/50 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-purple-500/50">
                                <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            </div>
                            <button id="toggleChannelsBtn" class="bg-gray-700 text-gray-300 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                <span id="toggleChannelsText">Show All</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Available Channels Grid -->
                    <div class="p-6 max-h-80 overflow-y-auto dark-scrollbar">
                        <div id="availableChannelsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <!-- Channels will be populated by JavaScript -->
                        </div>
                        
                        <!-- No Channels Message -->
                        <div id="noChannelsMessage" class="text-center py-8 text-gray-400 hidden">
                            <i class="fas fa-tv text-3xl mb-4"></i>
                            <p class="text-sm">No channels found</p>
                            <p class="text-xs mt-1">Try adjusting your search or enable more channels in Setup</p>
                        </div>
                    </div>
                </div>
                
                <!-- Playlist Editor -->
                <div id="playlistEditor" class="bg-gradient-to-br from-gray-800/40 to-gray-900/60 backdrop-blur-xl border border-gray-600/30 rounded-2xl shadow-2xl shadow-gray-900/50 hidden">
                    
                    <!-- Playlist Editor Header -->
                    <div class="p-6 border-b border-gray-700/50">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 id="selectedPlaylistName" class="text-xl font-semibold text-white">Select a Playlist</h2>
                                <p id="selectedPlaylistChannelCount" class="text-gray-400 text-sm"></p>
                            </div>
                            <div class="flex gap-2">
                                <button id="clearPlaylistBtn" class="bg-red-600/20 hover:bg-red-600/30 text-red-400 px-3 py-2 rounded-lg text-sm transition-colors hidden">
                                    <i class="fas fa-trash mr-1"></i>
                                    Clear
                                </button>
                                <button id="savePlaylistBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                                    <i class="fas fa-save mr-1"></i>
                                    Save
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Playlist Channels -->
                    <div class="p-6">
                        <div id="playlistChannelsList" class="space-y-2">
                            <!-- Playlist channels will be populated by JavaScript -->
                        </div>
                        
                        <!-- Empty Playlist State -->
                        <div id="emptyPlaylistState" class="text-center py-12 text-gray-400 hidden">
                            <i class="fas fa-list text-4xl mb-4"></i>
                            <p class="text-sm mb-2">This playlist is empty</p>
                            <p class="text-xs">Add channels from the Available Channels section above</p>
                        </div>
                    </div>
                </div>
                
                <!-- No Playlist Selected State -->
                <div id="noPlaylistSelected" class="bg-gradient-to-br from-gray-800/40 to-gray-900/60 backdrop-blur-xl border border-gray-600/30 rounded-2xl shadow-2xl shadow-gray-900/50 p-12 text-center">
                    <i class="fas fa-hand-pointer text-4xl text-gray-400 mb-4"></i>
                    <h3 class="text-xl font-medium text-white mb-2">Select a Playlist</h3>
                    <p class="text-gray-400">Choose a playlist from the left sidebar to start editing, or create a new one</p>
                </div>
            </div>
        </div>
        
        <!-- Create/Edit Playlist Modal -->
        <div id="playlistModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
            <div class="bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-600/30 rounded-2xl p-6 w-full max-w-md shadow-2xl">
                <h3 id="modalTitle" class="text-xl font-semibold text-white mb-4">Create New Playlist</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Playlist Name</label>
                        <input type="text" 
                               id="newPlaylistName"
                               placeholder="Enter playlist name..."
                               class="w-full bg-gray-700/50 border border-gray-600/50 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500/50">
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button id="savePlaylistModalBtn" class="flex-1 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white py-3 rounded-lg font-medium transition-colors">
                            <span id="savePlaylistModalText">Create</span>
                        </button>
                        <button id="cancelPlaylistModalBtn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-lg font-medium transition-colors">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Drag and drop styles */
.drag-over {
    border-color: #7c3aed !important;
    background-color: rgba(124, 58, 237, 0.1) !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
}

.drag-handle:hover {
    color: #a855f7 !important;
}

/* Draggable item styles */
[draggable="true"] {
    transition: all 0.2s ease;
}

[draggable="true"]:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

/* Dark scrollbar styles */
.dark-scrollbar::-webkit-scrollbar {
    width: 8px;
}

.dark-scrollbar::-webkit-scrollbar-track {
    background: rgba(31, 41, 55, 0.5); /* gray-800 with opacity */
    border-radius: 4px;
}

.dark-scrollbar::-webkit-scrollbar-thumb {
    background: rgba(107, 114, 128, 0.8); /* gray-500 with opacity */
    border-radius: 4px;
}

.dark-scrollbar::-webkit-scrollbar-thumb:hover {
    background: rgba(156, 163, 175, 0.9); /* gray-400 with opacity */
}

/* Firefox scrollbar support */
.dark-scrollbar {
    scrollbar-width: thin;
    scrollbar-color: rgba(107, 114, 128, 0.8) rgba(31, 41, 55, 0.5);
}

/* Available channels grid layout consistency */
#availableChannelsGrid {
    align-content: start;
}

.available-channel-card {
    min-height: 80px;
    display: flex;
    flex-direction: column;
}
</style>

<script>
// Playlist Manager JavaScript functionality

class PlaylistManager {
    constructor() {
        this.playlists = {{ playlists | tojson | safe }};
        this.channels = {{ channels | tojson | safe }};
        this.selectedPlaylist = null;
        this.showCreatePlaylistModal = false;
        this.editingPlaylist = null;
        this.newPlaylistName = '';
        this.channelSearch = '';
        this.showAllChannels = false;
        this.filteredAvailableChannels = [];
        
        this.init();
    }
    
    init() {
        this.setupEventListeners();
        this.renderPlaylists();
        this.renderAvailableChannels();
        this.updateUI();
    }
    
    setupEventListeners() {
        // Create playlist button
        document.getElementById('createPlaylistBtn').addEventListener('click', () => {
            this.showModal();
        });
        
        // Modal buttons
        document.getElementById('savePlaylistModalBtn').addEventListener('click', () => {
            this.createOrUpdatePlaylist();
        });
        
        document.getElementById('cancelPlaylistModalBtn').addEventListener('click', () => {
            this.hideModal();
        });
        
        // Modal input
        document.getElementById('newPlaylistName').addEventListener('input', (e) => {
            this.newPlaylistName = e.target.value;
            this.updateModalSaveButton();
        });
        
        document.getElementById('newPlaylistName').addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                this.createOrUpdatePlaylist();
            }
        });
        
        // Channel search
        document.getElementById('channelSearch').addEventListener('input', (e) => {
            this.channelSearch = e.target.value;
            this.renderAvailableChannels();
        });
        
        // Toggle channels button
        document.getElementById('toggleChannelsBtn').addEventListener('click', () => {
            this.showAllChannels = !this.showAllChannels;
            this.updateToggleButton();
            this.renderAvailableChannels();
        });
        
        // Playlist editor buttons
        document.getElementById('clearPlaylistBtn').addEventListener('click', () => {
            this.clearPlaylist();
        });
        
        document.getElementById('savePlaylistBtn').addEventListener('click', () => {
            this.savePlaylist();
        });
        
        // Modal close on background click
        document.getElementById('playlistModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('playlistModal')) {
                this.hideModal();
            }
        });
    }
    
    get enabledChannels() {
        return this.channels.filter(channel => channel.is_enabled);
    }
    
    getFilteredAvailableChannels() {
        let filtered = this.showAllChannels ? this.channels : this.enabledChannels;
        
        if (this.channelSearch) {
            const query = this.channelSearch.toLowerCase();
            filtered = filtered.filter(channel => 
                channel.name.toLowerCase().includes(query) ||
                (channel.channel_number && channel.channel_number.toString().includes(query))
            );
        }
        
        return filtered;
    }
    
    renderPlaylists() {
        const playlistsList = document.getElementById('playlistsList');
        const playlistsEmptyState = document.getElementById('playlistsEmptyState');
        const playlistCount = document.getElementById('playlistCount');
        
        playlistCount.textContent = `${this.playlists.length} playlists`;
        
        if (this.playlists.length === 0) {
            playlistsList.innerHTML = '';
            playlistsEmptyState.classList.remove('hidden');
        } else {
            playlistsEmptyState.classList.add('hidden');
            playlistsList.innerHTML = this.playlists.map(playlist => this.renderPlaylistCard(playlist)).join('');
            
            // Add event listeners to playlist cards
            this.playlists.forEach(playlist => {
                const card = document.getElementById(`playlist-${playlist.id}`);
                if (card) {
                    card.addEventListener('click', () => {
                        this.selectPlaylist(playlist);
                    });
                }
                
                const editBtn = document.getElementById(`edit-playlist-${playlist.id}`);
                if (editBtn) {
                    editBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.editPlaylist(playlist);
                    });
                }
                
                const deleteBtn = document.getElementById(`delete-playlist-${playlist.id}`);
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.deletePlaylist(playlist.id);
                    });
                }
            });
        }
    }
    
    renderPlaylistCard(playlist) {
        const isSelected = this.selectedPlaylist?.id === playlist.id;
        const cardClasses = isSelected 
            ? 'bg-purple-600/20 border-purple-500/50' 
            : 'bg-gray-800/30 border-gray-700/50';
            
        return `
            <div id="playlist-${playlist.id}" class="mb-3 p-4 rounded-xl border transition-all duration-200 cursor-pointer hover:bg-gray-700/30 ${cardClasses}">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <h3 class="font-medium text-white text-sm">${playlist.name}</h3>
                        <p class="text-xs text-gray-400 mt-1">${playlist.channels.length} channels</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="edit-playlist-${playlist.id}" class="text-gray-400 hover:text-white p-1">
                            <i class="fas fa-edit text-sm"></i>
                        </button>
                        <button id="delete-playlist-${playlist.id}" class="text-gray-400 hover:text-red-400 p-1">
                            <i class="fas fa-trash text-sm"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    renderAvailableChannels() {
        this.filteredAvailableChannels = this.getFilteredAvailableChannels();
        const channelsGrid = document.getElementById('availableChannelsGrid');
        const noChannelsMessage = document.getElementById('noChannelsMessage');
        const channelsCount = document.getElementById('availableChannelsCount');
        
        channelsCount.textContent = `${this.filteredAvailableChannels.length} channels`;
        
        if (this.filteredAvailableChannels.length === 0) {
            channelsGrid.innerHTML = '';
            noChannelsMessage.classList.remove('hidden');
        } else {
            noChannelsMessage.classList.add('hidden');
            channelsGrid.innerHTML = this.filteredAvailableChannels.map(channel => this.renderChannelCard(channel)).join('');
            
            // Add event listeners to channel cards
            this.filteredAvailableChannels.forEach(channel => {
                const addBtn = document.getElementById(`add-channel-${channel.id}`);
                if (addBtn) {
                    addBtn.addEventListener('click', () => {
                        this.addChannelToPlaylist(channel);
                    });
                }
            });
        }
    }
    
    renderChannelCard(channel) {
        const isDisabled = !this.selectedPlaylist || this.isChannelInPlaylist(channel.id);
        const buttonClasses = isDisabled 
            ? 'text-gray-600 cursor-not-allowed' 
            : 'text-purple-400 hover:text-purple-300';
            
        return `
            <div class="available-channel-card bg-gray-800/30 border border-gray-700/50 rounded-lg p-3 hover:bg-gray-700/40 transition-colors">
                <div class="flex items-center justify-between h-full">
                    <div class="flex items-center flex-1">
                        ${channel.logo_url ? 
                            `<img src="${channel.logo_url}" 
                                 alt="${channel.name}"
                                 class="w-6 h-6 rounded mr-3 object-cover"
                                 onerror="this.style.display='none'">` : 
                            ''
                        }
                        <div class="flex-1 min-w-0">
                            <h4 class="text-white font-medium text-sm truncate">${channel.name}</h4>
                            <p class="text-gray-400 text-xs">${channel.channel_number ? 'Ch. ' + channel.channel_number : ''}</p>
                        </div>
                    </div>
                    <button id="add-channel-${channel.id}" 
                            ${isDisabled ? 'disabled' : ''}
                            class="ml-2 p-1 transition-colors ${buttonClasses}">
                        <i class="fas fa-plus-circle"></i>
                    </button>
                </div>
            </div>
        `;
    }
    
    renderPlaylistChannels() {
        const channelsList = document.getElementById('playlistChannelsList');
        const emptyState = document.getElementById('emptyPlaylistState');
        
        if (!this.selectedPlaylist || this.selectedPlaylist.channels.length === 0) {
            channelsList.innerHTML = '';
            emptyState.classList.remove('hidden');
        } else {
            emptyState.classList.add('hidden');
            channelsList.innerHTML = this.selectedPlaylist.channels.map((channel, index) => 
                this.renderPlaylistChannelCard(channel, index)
            ).join('');
            
            // Add event listeners to remove buttons
            this.selectedPlaylist.channels.forEach(channel => {
                const removeBtn = document.getElementById(`remove-channel-${channel.id}`);
                if (removeBtn) {
                    removeBtn.addEventListener('click', () => {
                        this.removeChannelFromPlaylist(channel.id);
                    });
                }
            });
            
            // Initialize drag and drop functionality
            this.initializeDragAndDrop();
        }
    }
    
    initializeDragAndDrop() {
        const channelsList = document.getElementById('playlistChannelsList');
        let draggedElement = null;
        let draggedIndex = null;
        
        // Add drag event listeners to all channel items
        this.selectedPlaylist.channels.forEach((channel, index) => {
            const channelElement = channelsList.children[index];
            if (channelElement) {
                channelElement.setAttribute('draggable', 'true');
                channelElement.dataset.index = index;
                
                // Drag start
                channelElement.addEventListener('dragstart', (e) => {
                    draggedElement = channelElement;
                    draggedIndex = parseInt(channelElement.dataset.index);
                    channelElement.style.opacity = '0.5';
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', channelElement.outerHTML);
                });
                
                // Drag end
                channelElement.addEventListener('dragend', (e) => {
                    channelElement.style.opacity = '1';
                    draggedElement = null;
                    draggedIndex = null;
                    
                    // Remove drag over styles from all elements
                    const allItems = channelsList.querySelectorAll('.drag-over');
                    allItems.forEach(item => item.classList.remove('drag-over'));
                });
                
                // Drag over
                channelElement.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    
                    if (draggedElement && channelElement !== draggedElement) {
                        channelElement.classList.add('drag-over');
                    }
                });
                
                // Drag leave
                channelElement.addEventListener('dragleave', (e) => {
                    channelElement.classList.remove('drag-over');
                });
                
                // Drop
                channelElement.addEventListener('drop', (e) => {
                    e.preventDefault();
                    channelElement.classList.remove('drag-over');
                    
                    if (draggedElement && channelElement !== draggedElement) {
                        const dropIndex = parseInt(channelElement.dataset.index);
                        this.reorderChannel(draggedIndex, dropIndex);
                    }
                });
            }
        });
    }
    
    reorderChannel(fromIndex, toIndex) {
        if (!this.selectedPlaylist || fromIndex === toIndex) return;
        
        // Remove the channel from the old position
        const [movedChannel] = this.selectedPlaylist.channels.splice(fromIndex, 1);
        
        // Insert the channel at the new position
        this.selectedPlaylist.channels.splice(toIndex, 0, movedChannel);
        
        // Re-render the playlist channels to reflect the new order
        this.renderPlaylistChannels();
        this.updateUI();
    }
    
    renderPlaylistChannelCard(channel, index) {
        return `
            <div class="bg-gray-800/50 border border-gray-700/50 rounded-lg p-3 hover:bg-gray-700/40 transition-colors">
                <div class="flex items-center">
                    <div class="drag-handle cursor-move text-gray-400 hover:text-white mr-3 p-1">
                        <i class="fas fa-grip-vertical"></i>
                    </div>
                    <div class="flex items-center justify-between flex-1">
                        <div class="flex items-center">
                            <span class="text-gray-400 text-sm mr-3 w-6">${index + 1}</span>
                            ${channel.logo_url ? 
                                `<img src="${channel.logo_url}" 
                                     alt="${channel.name}"
                                     class="w-6 h-6 rounded mr-3 object-cover"
                                     onerror="this.style.display='none'">` : 
                                ''
                            }
                            <div>
                                <h4 class="text-white font-medium text-sm">${channel.name}</h4>
                                <p class="text-gray-400 text-xs">${channel.channel_number ? 'Ch. ' + channel.channel_number : ''}</p>
                            </div>
                        </div>
                        <button id="remove-channel-${channel.id}" class="text-gray-400 hover:text-red-400 p-1 transition-colors">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    selectPlaylist(playlist) {
        this.selectedPlaylist = { ...playlist };
        this.renderPlaylists(); // Re-render to update selection styling
        this.updateUI();
        this.renderPlaylistChannels();
        this.renderAvailableChannels(); // Re-render to update add button states
    }
    
    showModal(editingPlaylist = null) {
        this.editingPlaylist = editingPlaylist;
        this.newPlaylistName = editingPlaylist ? editingPlaylist.name : '';
        
        document.getElementById('modalTitle').textContent = editingPlaylist ? 'Edit Playlist' : 'Create New Playlist';
        document.getElementById('savePlaylistModalText').textContent = editingPlaylist ? 'Update' : 'Create';
        document.getElementById('newPlaylistName').value = this.newPlaylistName;
        document.getElementById('playlistModal').classList.remove('hidden');
        
        this.updateModalSaveButton();
        
        // Focus the input
        setTimeout(() => {
            document.getElementById('newPlaylistName').focus();
        }, 100);
    }
    
    hideModal() {
        document.getElementById('playlistModal').classList.add('hidden');
        this.editingPlaylist = null;
        this.newPlaylistName = '';
    }
    
    updateModalSaveButton() {
        const saveBtn = document.getElementById('savePlaylistModalBtn');
        const isValid = this.newPlaylistName.trim().length > 0;
        
        saveBtn.disabled = !isValid;
        saveBtn.className = isValid 
            ? 'flex-1 bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-medium transition-colors'
            : 'flex-1 bg-gray-600 cursor-not-allowed text-white py-3 rounded-lg font-medium transition-colors';
    }
    
    updateToggleButton() {
        const toggleBtn = document.getElementById('toggleChannelsBtn');
        const toggleText = document.getElementById('toggleChannelsText');
        
        if (this.showAllChannels) {
            toggleBtn.className = 'bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors';
            toggleText.textContent = 'Show Available';
        } else {
            toggleBtn.className = 'bg-gray-700 text-gray-300 px-4 py-2 rounded-lg text-sm font-medium transition-colors';
            toggleText.textContent = 'Show All';
        }
    }
    
    updateUI() {
        const playlistEditor = document.getElementById('playlistEditor');
        const noPlaylistSelected = document.getElementById('noPlaylistSelected');
        const selectedPlaylistName = document.getElementById('selectedPlaylistName');
        const selectedPlaylistChannelCount = document.getElementById('selectedPlaylistChannelCount');
        const clearPlaylistBtn = document.getElementById('clearPlaylistBtn');
        
        if (this.selectedPlaylist) {
            playlistEditor.classList.remove('hidden');
            noPlaylistSelected.classList.add('hidden');
            
            selectedPlaylistName.textContent = this.selectedPlaylist.name;
            selectedPlaylistChannelCount.textContent = `${this.selectedPlaylist.channels.length} channels`;
            
            if (this.selectedPlaylist.channels.length > 0) {
                clearPlaylistBtn.classList.remove('hidden');
            } else {
                clearPlaylistBtn.classList.add('hidden');
            }
        } else {
            playlistEditor.classList.add('hidden');
            noPlaylistSelected.classList.remove('hidden');
        }
    }
    
    createOrUpdatePlaylist() {
        if (!this.newPlaylistName.trim()) return;
        
        if (this.editingPlaylist) {
            // Update existing playlist
            const index = this.playlists.findIndex(p => p.id === this.editingPlaylist.id);
            if (index !== -1) {
                this.playlists[index].name = this.newPlaylistName.trim();
                if (this.selectedPlaylist?.id === this.editingPlaylist.id) {
                    this.selectedPlaylist.name = this.newPlaylistName.trim();
                }
            }
        } else {
            // Create new playlist
            const newPlaylist = {
                id: Date.now(),
                name: this.newPlaylistName.trim(),
                channels: []
            };
            this.playlists.push(newPlaylist);
            this.selectedPlaylist = newPlaylist;
        }
        
        this.hideModal();
        this.renderPlaylists();
        this.updateUI();
        this.saveAllPlaylists();
    }
    
    editPlaylist(playlist) {
        this.showModal(playlist);
    }
    
    deletePlaylist(playlistId) {
        if (confirm('Are you sure you want to delete this playlist? This action cannot be undone.')) {
            this.playlists = this.playlists.filter(p => p.id !== playlistId);
            if (this.selectedPlaylist?.id === playlistId) {
                this.selectedPlaylist = null;
            }
            this.renderPlaylists();
            this.updateUI();
            this.saveAllPlaylists();
        }
    }
    
    addChannelToPlaylist(channel) {
        if (!this.selectedPlaylist || this.isChannelInPlaylist(channel.id)) return;
        
        this.selectedPlaylist.channels.push({ ...channel });
        this.renderPlaylistChannels();
        this.renderAvailableChannels(); // Re-render to update add button states
        this.updateUI();
    }
    
    removeChannelFromPlaylist(channelId) {
        if (!this.selectedPlaylist) return;
        
        this.selectedPlaylist.channels = this.selectedPlaylist.channels.filter(
            c => c.id !== channelId
        );
        this.renderPlaylistChannels();
        this.renderAvailableChannels(); // Re-render to update add button states
        this.updateUI();
    }
    
    isChannelInPlaylist(channelId) {
        return this.selectedPlaylist?.channels.some(c => c.id === channelId) || false;
    }
    
    clearPlaylist() {
        if (confirm('Are you sure you want to remove all channels from this playlist?')) {
            this.selectedPlaylist.channels = [];
            this.renderPlaylistChannels();
            this.renderAvailableChannels(); // Re-render to update add button states
            this.updateUI();
        }
    }
    
    savePlaylist() {
        if (!this.selectedPlaylist) return;
        
        const index = this.playlists.findIndex(p => p.id === this.selectedPlaylist.id);
        if (index !== -1) {
            this.playlists[index] = { ...this.selectedPlaylist };
        }
        
        this.saveAllPlaylists();
    }
    
    async saveAllPlaylists() {
        try {
            const response = await fetch('/api/playlists', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    playlists: this.playlists
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to save playlists');
            }
            
            // Show success feedback (could add a toast notification here)
            
        } catch (error) {
            console.error('Error saving playlists:', error);
            alert('Failed to save playlists. Please try again.');
        }
    }
}

// Initialize the playlist manager when the DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    window.playlistManager = new PlaylistManager();
});
</script>

{% endblock %}
