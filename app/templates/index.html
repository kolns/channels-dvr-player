{% extends "base.html" %}

{% block title %}{{ config.get_page_title('home') }}{% endblock %}

{% block content %}
<div class="flex flex-col items-center justify-top text-center">
    <div class="max-w-7xl mx-auto px-8">
        
        {% if user_state == "no_dvr" %}
            <!-- STATE: No DVR Server Found -->
            <div class="mb-8 mt-8">
                <div class="relative">
                    <!-- Warning Background Pattern -->
                    <div class="absolute inset-0 bg-gradient-to-r from-orange-500/20 via-red-500/20 to-pink-500/20 rounded-2xl blur-lg"></div>
                    
                    <!-- Main Warning Card -->
                    <div class="relative bg-gradient-to-br from-gray-800/80 to-gray-900/80 backdrop-blur-xl border-2 border-orange-500/50 rounded-2xl p-8 shadow-2xl shadow-orange-900/30">
                        
                        <!-- Warning Icon -->
                        <div class="flex justify-center mb-6">
                            <div class="w-20 h-20 bg-gradient-to-br from-orange-500 to-red-500 rounded-full flex items-center justify-center shadow-lg shadow-orange-500/30">
                                <i class="fas fa-satellite-dish text-3xl text-white"></i>
                            </div>
                        </div>
                        
                        <!-- Title -->
                        <div class="text-center mb-6">
                            <h2 class="text-3xl font-bold bg-gradient-to-r from-orange-400 via-red-400 to-pink-400 bg-clip-text text-transparent mb-2">
                                Channels DVR Server Not Found
                            </h2>
                            <p class="text-lg text-gray-300">
                                when scanning your network...
                            </p>
                        </div>
                        
                        <!-- Message Content -->
                        <div class="bg-gray-700/50 backdrop-blur-sm border border-gray-600/50 rounded-xl p-6 mb-6">
                            <div class="text-gray-100 space-y-4">
                                <p class="text-gray-300 text-center">
                                    Make sure your Channels DVR server is running and accessible, then refresh this page.
                                </p>
                            </div>
                        </div>
                        
                        <!-- Troubleshooting Section -->
                        <div class="bg-gray-800/60 backdrop-blur-sm border border-gray-600/40 rounded-xl p-6 mb-6">
                            <h3 class="text-white font-semibold mb-4 flex items-center">
                                <i class="fas fa-tools text-orange-400 mr-2"></i>
                                Troubleshooting Tips
                            </h3>
                            <ul class="text-gray-300 text-sm space-y-2">
                                <li class="flex items-start">
                                    <i class="fas fa-check-circle text-orange-400 mr-2 mt-0.5 text-xs"></i>
                                    Auto discovery of Channels DVR is required in this alpha release 
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-check-circle text-orange-400 mr-2 mt-0.5 text-xs"></i>
                                    Check that this device is on the same network as your DVR server
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-check-circle text-orange-400 mr-2 mt-0.5 text-xs"></i>
                                    Verify firewall settings allow mDNS discovery
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-check-circle text-orange-400 mr-2 mt-0.5 text-xs"></i>
                                    Try refreshing the page after a few moments
                                </li>
                            </ul>
                        </div>
                        
                        <!-- Action Button -->
                        <div class="flex justify-center">
                            <button onclick="window.location.reload()" class="group bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 text-white font-bold py-3 px-8 rounded-lg transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                                <i class="fas fa-refresh mr-2 group-hover:animate-spin"></i>
                                Scan Again
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        {% elif user_state == "need_setup" %}
            <!-- STATE: DVR Found, Need Channel Setup -->
            <div class="mb-8 mt-8">
                <div class="relative">
                    <!-- Success Background Pattern -->
                    <div class="absolute inset-0 bg-gradient-to-r from-blue-500/20 via-cyan-500/20 to-teal-500/20 rounded-2xl blur-lg"></div>
                    
                    <!-- Main Success Card -->
                    <div class="relative bg-gradient-to-br from-gray-800/80 to-gray-900/80 backdrop-blur-xl border-2 border-blue-500/50 rounded-2xl p-8 shadow-2xl shadow-blue-900/30">
                        
                        <!-- Success Icon -->
                        <div class="flex justify-center mb-6">
                            <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full flex items-center justify-center shadow-lg shadow-blue-500/30">
                                <i class="fas fa-satellite-dish text-3xl text-white"></i>
                            </div>
                        </div>
                        
                        <!-- Title -->
                        <div class="text-center mb-6">
                            <h2 class="text-3xl font-bold bg-gradient-to-r from-blue-400 via-cyan-400 to-teal-400 bg-clip-text text-transparent mb-2">
                                ðŸš€ Channels DVR Server Connected Successfully
                            </h2>
                            <p class="text-lg text-gray-300">
                                Ready for Channel Setup
                            </p>
                        </div>
                        
                        <!-- Server Info -->
                        <div class="bg-gray-700/50 backdrop-blur-sm border border-gray-600/50 rounded-xl p-6 mb-6">
                            <div class="flex flex-col space-y-4 sm:flex-row sm:items-center sm:justify-between sm:space-y-0 min-w-0">
                                <div class="flex items-center space-x-4 flex-1 min-w-0">
                                    <div class="w-14 h-14 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <i class="fas fa-server text-2xl text-white"></i>
                                    </div>
                                    <div class="min-w-0 flex-1 max-w-md">
                                        <h3 class="text-white font-semibold text-lg mb-1 truncate">{{ server_info.name }}</h3>
                                        <p class="text-gray-400 text-xs break-all">{{ server_info.url }}</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2 bg-green-600/20 backdrop-blur-sm border border-green-500/30 rounded-full px-4 py-2 flex-shrink-0 ml-4">
                                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                    <span class="text-green-400 text-sm font-medium">Online</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Next Steps -->
                        <div class="bg-gray-800/60 backdrop-blur-sm border border-gray-600/40 rounded-xl p-6 mb-6">
                            <h3 class="text-white font-semibold mb-4 flex items-center">
                                <i class="fas fa-list-ol text-blue-400 mr-2"></i>
                                Next Steps
                            </h3>
                            <div class="space-y-3 text-gray-300 text-sm">
                                <div class="flex items-start">
                                    <span class="bg-blue-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center mr-3 mt-0.5">1</span>
                                    <span>Go to Setup to import channels from your DVR server</span>
                                </div>
                                <div class="flex items-start">
                                    <span class="bg-gray-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center mr-3 mt-0.5">2</span>
                                    <span>Choose which channels you want to use in the app</span>
                                </div>
                                <div class="flex items-start">
                                    <span class="bg-gray-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center mr-3 mt-0.5">3</span>
                                    <span>Create playlists with your selected channels</span>
                                </div>
                                <div class="flex items-start">
                                    <span class="bg-gray-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center mr-3 mt-0.5">4</span>
                                    <span>Start watching live TV!</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Button -->
                        <div class="flex justify-center">
                            <a href="/setup" class="group bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 text-white font-bold py-3 px-8 rounded-lg transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                                <i class="fas fa-cog mr-2"></i>
                                Go to Setup
                            </a>
                        </div>
                    </div>
                </div>
            </div>

        {% elif user_state == "need_playlists" %}
            <!-- STATE: Channels Exist, Need Playlists -->
            <!-- Hero Section -->
            <div class="mb-8 mt-8">
                <div class="relative">
                    <div class="absolute inset-0 bg-gradient-to-r from-blue-600/10 via-purple-600/10 to-green-600/10 rounded-2xl blur-xl"></div>
                    <div class="relative bg-gray-800/40 backdrop-blur-sm border border-gray-600/30 rounded-2xl p-8 shadow-2xl">
                        <div class="flex items-center justify-center mb-2">
                            <div class="w-16 h-16 bg-gradient-to-br from-purple-600 to-purple-700 rounded-full flex items-center justify-center mr-4 shadow-lg">
                                <i class="fas fa-list text-2xl text-white"></i>
                            </div>
                            <div class="text-center">
                                <h1 class="text-4xl font-bold text-white mb-2">Channels Ready</h1>
                                <p class="text-lg text-gray-300">Create Your Playlists</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Playlist Creation Card -->
            <div class="mb-8">
                <div class="relative">
                    <div class="absolute inset-0 bg-gradient-to-r from-purple-500/20 via-violet-500/20 to-blue-500/20 rounded-2xl blur-lg"></div>
                    <div class="relative bg-gradient-to-br from-gray-800/80 to-gray-900/80 backdrop-blur-xl border-2 border-purple-500/50 rounded-2xl p-8 shadow-2xl shadow-purple-900/30">
                        
                        <!-- Playlist Icon -->
                        <div class="flex justify-center mb-6">
                            <div class="w-20 h-20 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center shadow-lg shadow-purple-500/30">
                                <i class="fas fa-heart text-3xl text-white"></i>
                            </div>
                        </div>
                        
                        <!-- Title -->
                        <div class="text-center mb-6">
                            <h2 class="text-3xl font-bold bg-gradient-to-r from-purple-500 via-violet-500 to-blue-500 bg-clip-text text-transparent mb-2">
                                ðŸ“º Create Your Playlists
                            </h2>
                            <p class="text-lg text-gray-300">
                                You have {{ channels_count }} channels ready! Organize them into playlists.
                            </p>
                        </div>
                        
                        <!-- Stats -->
                        <div class="bg-gray-700/50 backdrop-blur-sm border border-gray-600/50 rounded-xl p-6 mb-6">
                            <div class="grid grid-cols-2 gap-6 text-center">
                                <div>
                                    <div class="text-3xl font-bold text-green-400 mb-1">{{ channels_count }}</div>
                                    <div class="text-gray-400 text-sm">Channels Available</div>
                                </div>
                                <div>
                                    <div class="text-3xl font-bold text-purple-400 mb-1">0</div>
                                    <div class="text-gray-400 text-sm">Playlists Created</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Button -->
                        <div class="flex justify-center">
                            <a href="/playlist" class="group bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 text-white font-bold py-3 px-8 rounded-lg transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                                <i class="fas fa-heart mr-2"></i>
                                Create Playlists
                            </a>
                        </div>
                    </div>
                </div>
            </div>

        {% else %}
            <!-- STATE: Ready to Stream -->
            <!-- Hero Section -->
            <div class="mb-8 mt-8">
                <div class="relative">
                    <div class="absolute inset-0 bg-gradient-to-r from-blue-600/10 via-purple-600/10 to-green-600/10 rounded-2xl blur-xl"></div>
                    <div class="relative bg-gray-800/40 backdrop-blur-sm border border-gray-600/30 rounded-2xl p-8 shadow-2xl">
                        <div class="flex items-center justify-center mb-2">
                            <div class="w-16 h-16 bg-gradient-to-br from-red-600 to-red-700 rounded-full flex items-center justify-center mr-4 shadow-lg">
                                <i class="fas fa-play text-2xl text-white"></i>
                            </div>
                            <div class="text-center">
                                <h1 class="text-4xl font-bold text-white mb-2">Now Streaming</h1>
                                <p class="text-lg text-gray-300">Live TV â€¢ From Your Browser</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

                        <!-- Quick Actions -->
            {% if playlists_count > 0 %}
            <div class="mb-8 relative">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <a href="/player" class="group bg-gradient-to-r from-green-600 to-green-700 hover:from-green-500 hover:to-green-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-300 text-center shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                        <i class="fas fa-play text-xl mb-2"></i>
                        <div class="font-bold">Start Watching</div>
                        <div class="text-sm opacity-90">{{ playlists_count }} playlists ready</div>
                    </a>
                    <a href="/playlist" class="group bg-gray-700/60 hover:bg-gray-600/60 border border-gray-600/50 hover:border-gray-500/50 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-300 text-center backdrop-blur-sm transform hover:-translate-y-0.5">
                        <i class="fas fa-list text-xl mb-2"></i>
                        <div class="font-bold">Manage Playlists</div>
                        <div class="text-sm opacity-90">{{ channels_count }} channels available</div>
                    </a>
                    <div class="group bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                        <div class="text-center mb-3">
                            <i class="fas fa-search text-xl mb-2"></i>
                            <div class="font-bold">Search</div>
                        </div>
                        <div class="relative">
                            <input type="text" 
                                   id="directSearchInput" 
                                   placeholder="Type to search..." 
                                   class="w-full bg-white/10 backdrop-blur-sm border border-white/20 rounded-lg px-3 py-2 text-white text-sm placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/30 focus:border-transparent focus:bg-white/15">
                            <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-white/70 text-xs"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Search Results Dropdown -->
                <div id="searchResultsDropdown" class="absolute left-0 right-0 top-full mt-4 hidden z-50">
                    <!-- Background Blur Overlay -->
                    <div class="absolute inset-0 bg-black/20 backdrop-blur-sm rounded-2xl"></div>
                    
                    <!-- Main Content -->
                    <div class="relative bg-gradient-to-br from-gray-800/90 via-gray-700/90 to-gray-900/90 backdrop-blur-xl border-2 border-gray-600/30 rounded-2xl p-6 shadow-2xl shadow-black/30">
                        <!-- Animated Background Pattern -->
                        <div class="absolute inset-0 bg-gradient-to-r from-blue-600/5 via-purple-600/5 to-green-600/5 rounded-2xl blur-xl"></div>
                        
                        <div class="relative">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-bold bg-gradient-to-r from-blue-400 via-purple-400 to-green-400 bg-clip-text text-transparent flex items-center">
                                    <i class="fas fa-search text-blue-400 mr-3 text-xl"></i>
                                    Search Results
                                </h3>
                                <button id="clearSearchBtn" class="group bg-gray-700/60 hover:bg-red-600/60 border border-gray-600/50 hover:border-red-500/50 text-gray-400 hover:text-white px-3 py-2 rounded-lg transition-all duration-300 text-sm backdrop-blur-sm">
                                    <i class="fas fa-times mr-1 group-hover:rotate-90 transition-transform duration-300"></i>Clear
                                </button>
                            </div>
                            
                            <div id="searchResults" class="max-h-96 overflow-y-auto custom-scrollbar">
                                <div class="text-center text-gray-400 py-8">
                                    <i class="fas fa-search text-4xl mb-4 opacity-50"></i>
                                    <p>Start typing to search for channels and programs</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recently Watched Channels -->
            <div class="mb-8">
                <div class="bg-gradient-to-r from-gray-800/30 to-gray-700/30 backdrop-blur-sm border border-gray-600/30 rounded-2xl p-6 shadow-2xl">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-white flex items-center">
                            <i class="fas fa-history text-purple-400 mr-3"></i>
                            Recently Watched
                        </h2>
                        <button id="clearHistoryBtn" class="text-gray-400 hover:text-white text-sm">
                            <i class="fas fa-trash mr-1"></i>Clear History
                        </button>
                    </div>
                    
                    <div id="recentChannels" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        <div class="text-center text-gray-400 col-span-full py-8">
                            <i class="fas fa-tv text-4xl mb-4 opacity-50"></i>
                            <p>No recently watched channels yet</p>
                            <p class="text-sm">Start watching to see your history here</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Starting Soon -->
            {% if starting_soon_programs %}
            <div class="mb-8">
                <div class="bg-gradient-to-r from-gray-800/30 to-gray-700/30 backdrop-blur-sm border border-gray-600/30 rounded-2xl p-6 shadow-2xl">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-white flex items-center">
                            <i class="fas fa-clock text-yellow-400 mr-3"></i>
                            Starting Soon
                            <span class="text-sm font-normal text-gray-400 ml-2">(Next 30 minutes)</span>
                        </h2>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {% for program in starting_soon_programs %}
                        <div class="bg-gray-800/60 backdrop-blur-sm border border-gray-600/40 rounded-xl p-4 hover:bg-gray-700/60 transition-all duration-300">
                            <div class="flex items-center mb-3">
                                {% if program.channel.logo_url %}
                                <img src="{{ program.channel.logo_url }}" alt="{{ program.channel.name }}" class="w-8 h-8 rounded mr-3 object-contain">
                                {% else %}
                                <div class="w-8 h-8 bg-blue-500 rounded flex items-center justify-center mr-3">
                                    <span class="text-white font-bold text-xs">{{ program.channel.name[:2] }}</span>
                                </div>
                                {% endif %}
                                <div class="flex-1 min-w-0">
                                    <h4 class="text-white font-medium text-sm truncate">{{ program.channel.name }}</h4>
                                    <p class="text-yellow-400 text-xs">Starts {{ program.start_time }}</p>
                                </div>
                            </div>
                            
                            <h5 class="text-white font-semibold mb-2 truncate">{{ program.title }}</h5>
                            {% if program.description %}
                            <p class="text-gray-300 text-sm line-clamp-2 mb-3">{{ program.description }}</p>
                            {% endif %}
                            
                            <div class="flex items-center justify-between">
                                <span class="bg-yellow-600/20 text-yellow-400 px-2 py-1 rounded text-xs font-medium">
                                    {{ program.minutes_until }} min
                                </span>
                                <button class="text-blue-400 hover:text-blue-300 text-sm">
                                    <i class="fas fa-bell mr-1"></i>Remind Me
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
            {% endif %}

            <!-- Live Program Cards Section -->
            {% if featured_programs %}
            <div class="bg-gradient-to-r from-gray-800/30 to-gray-700/30 backdrop-blur-sm border border-gray-600/30 rounded-2xl p-8 mb-8 shadow-2xl">

                <div class="relative">
                    <div id="cards-container" class="grid grid-cols-3 gap-6">
                        <!-- Cards will be inserted here by JavaScript -->
                    </div>
                    
                    <!-- Carousel indicators -->
                    <div class="flex justify-center mt-6">
                        <div id="carousel-indicators" class="flex space-x-2">
                            <!-- Indicators will be generated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Hidden template for cards -->
                <div id="card-template" style="display: none;">
                    {% for program_card in featured_programs %}
                    <div class="program-card" data-index="{{ loop.index0 }}">
                        <div class="bg-gray-800/60 backdrop-blur-sm border border-gray-600/40 rounded-xl overflow-hidden hover:bg-gray-700/60 transition-all duration-300 shadow-lg hover:shadow-xl cursor-pointer" onclick="selectChannel('{{ program_card.channel.id }}')">
                            <!-- Channel Header -->
                            <div class="bg-gradient-to-r from-gray-700/80 to-gray-600/80 text-white px-4 py-3 border-b border-gray-600/50">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        {% if program_card.channel.logo_url %}
                                        <img src="{{ program_card.channel.logo_url }}" alt="{{ program_card.channel.name }}" class="w-8 h-8 rounded mr-3 object-contain">
                                        {% else %}
                                        <div class="w-8 h-8 bg-blue-500 rounded flex items-center justify-center mr-3">
                                            <span class="text-white font-bold text-xs">{{ program_card.channel.name[:2] }}</span>
                                        </div>
                                        {% endif %}
                                        <div>
                                            <h3 class="font-semibold text-sm text-white">{{ program_card.channel.name }}</h3>
                                        </div>
                                    </div>
                                    <div class="bg-red-600 text-white px-2 py-1 rounded-full text-xs font-bold animate-pulse">
                                        LIVE
                                    </div>
                                </div>
                            </div>

                            <!-- Program Content -->
                            <div class="p-4">
                                <!-- Program Artwork -->
                                <div class="mb-3 flex justify-center h-32">
                                    {% if program_card.program.artwork_url %}
                                    <img src="{{ program_card.program.artwork_url }}" alt="{{ program_card.program.title }}" class="max-w-full h-full object-contain rounded-lg">
                                    {% endif %}
                                </div>
                                
                                <!-- Title and Time -->
                                <div class="mb-4">
                                    <h4 class="font-bold text-lg text-white mb-1 truncate">{{ program_card.program.title }}</h4>
                                    {% if program_card.start_time and program_card.end_time %}
                                    <p class="text-sm text-blue-300">{{ program_card.start_time }} - {{ program_card.end_time }}</p>
                                    {% endif %}
                                </div>
                                
                                <!-- Progress Bar Area - Always same height -->
                                <div style="height: 3rem;">
                                    {% if program_card.progress > 0 %}
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-xs text-gray-400">Progress</span>
                                        <span class="text-xs text-green-400">{{ program_card.remaining_minutes }} min left</span>
                                    </div>
                                    <div class="w-full bg-gray-700 rounded-full h-2">
                                        <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full transition-all duration-500" style="width: {{ program_card.progress }}%"></div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        {% endif %}

    </div>
</div>

<style>
.line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Custom Scrollbar for Search Results */
.custom-scrollbar::-webkit-scrollbar {
    width: 8px;
}

.custom-scrollbar::-webkit-scrollbar-track {
    background: rgba(55, 65, 81, 0.3);
    border-radius: 10px;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
    background: linear-gradient(to bottom, #3b82f6, #8b5cf6);
    border-radius: 10px;
    border: 1px solid rgba(75, 85, 99, 0.3);
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(to bottom, #2563eb, #7c3aed);
}

/* Firefox */
.custom-scrollbar {
    scrollbar-width: thin;
    scrollbar-color: #3b82f6 rgba(55, 65, 81, 0.3);
}
</style>

<script>
// Search functionality
document.addEventListener('DOMContentLoaded', function() {
    const directSearchInput = document.getElementById('directSearchInput');
    const searchResultsDropdown = document.getElementById('searchResultsDropdown');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    const searchResults = document.getElementById('searchResults');
    const clearHistoryBtn = document.getElementById('clearHistoryBtn');
    const recentChannels = document.getElementById('recentChannels');
    
    // Direct search functionality
    if (directSearchInput) {
        let searchTimeout;
        
        directSearchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            
            if (query.length === 0) {
                hideSearchResults();
                return;
            }
            
            if (query.length < 2) {
                showSearchResults();
                showSearchMessage('Type at least 2 characters to search');
                return;
            }
            
            showSearchResults();
            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 300);
        });
        
        directSearchInput.addEventListener('focus', () => {
            if (directSearchInput.value.trim().length >= 2) {
                showSearchResults();
            }
        });
        
        // Clear search on escape
        directSearchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                directSearchInput.value = '';
                hideSearchResults();
                directSearchInput.blur();
            }
        });
    }
    
    // Clear search button
    if (clearSearchBtn) {
        clearSearchBtn.addEventListener('click', () => {
            directSearchInput.value = '';
            hideSearchResults();
            directSearchInput.focus();
        });
    }
    
    // Hide search results when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('#directSearchInput') && !e.target.closest('#searchResultsDropdown')) {
            hideSearchResults();
        }
    });
    
    // Recently watched channels functionality
    if (clearHistoryBtn && recentChannels) {
        loadRecentChannels();
        
        clearHistoryBtn.addEventListener('click', () => {
            if (confirm('Clear all recently watched channels?')) {
                localStorage.removeItem('recentChannels');
                loadRecentChannels();
            }
        });
    }
    
    function showSearchResults() {
        if (searchResultsDropdown) {
            searchResultsDropdown.classList.remove('hidden');
        }
    }
    
    function hideSearchResults() {
        if (searchResultsDropdown) {
            searchResultsDropdown.classList.add('hidden');
        }
    }
    
    function showDefaultSearchMessage() {
        if (searchResults) {
            searchResults.innerHTML = `
                <div class="text-center text-gray-400 py-8">
                    <i class="fas fa-search text-4xl mb-4 opacity-50"></i>
                    <p>Start typing to search for channels and programs</p>
                </div>
            `;
        }
    }
    
    function showSearchMessage(message) {
        if (searchResults) {
            searchResults.innerHTML = `
                <div class="text-center text-gray-400 py-8">
                    <i class="fas fa-info-circle text-2xl mb-4 opacity-50"></i>
                    <p>${message}</p>
                </div>
            `;
        }
    }
    
    async function performSearch(query) {
        if (!searchResults) return;
        
        // Show loading state
        searchResults.innerHTML = `
            <div class="text-center text-gray-400 py-8">
                <i class="fas fa-spinner fa-spin text-2xl mb-4"></i>
                <p>Searching...</p>
            </div>
        `;
        
        try {
            const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
            const data = await response.json();
            
            if (data.success) {
                displaySearchResults(data.results);
            } else {
                showSearchMessage('Search failed. Please try again.');
            }
        } catch (error) {
            console.error('Search error:', error);
            showSearchMessage('Search error. Please check your connection.');
        }
    }
    
    function displaySearchResults(results) {
        if (!searchResults) return;
        
        if (results.length === 0) {
            searchResults.innerHTML = `
                <div class="text-center text-gray-400 py-8">
                    <i class="fas fa-search text-2xl mb-4 opacity-50"></i>
                    <p>No results found</p>
                    <p class="text-sm">Try a different search term</p>
                </div>
            `;
            return;
        }
        
        const resultHtml = results.map(result => {
            if (result.type === 'channel') {
                return `
                    <div class="group bg-gradient-to-r from-gray-800/60 to-gray-700/60 hover:from-blue-600/60 hover:to-purple-600/60 backdrop-blur-sm border border-gray-600/40 hover:border-blue-500/50 rounded-xl p-4 mb-3 transition-all duration-300 cursor-pointer shadow-lg hover:shadow-xl transform hover:-translate-y-0.5" onclick="selectChannel('${result.id}')">
                        <div class="flex items-center">
                            ${result.logo_url ? 
                                `<div class="w-12 h-12 rounded-lg overflow-hidden mr-4 bg-gray-700/50 flex items-center justify-center border border-gray-600/30">
                                    <img src="${result.logo_url}" alt="${result.name}" class="w-full h-full object-contain">
                                 </div>` :
                                `<div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-500 rounded-lg flex items-center justify-center mr-4 shadow-lg">
                                    <span class="text-white font-bold text-sm">${result.name.substr(0, 2)}</span>
                                 </div>`
                            }
                            <div class="flex-1">
                                <h4 class="text-white font-semibold group-hover:text-blue-200 transition-colors">${result.name}</h4>
                                <p class="text-gray-400 text-sm group-hover:text-blue-300 transition-colors">${result.current_program || 'Channel'}</p>
                            </div>
                            <div class="flex items-center space-x-3">
                                <div class="bg-green-600/20 text-green-400 px-2 py-1 rounded-full text-xs font-medium border border-green-500/30">
                                    LIVE
                                </div>
                                <i class="fas fa-play text-green-400 group-hover:text-green-300 transition-colors text-lg"></i>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="group bg-gradient-to-r from-gray-800/60 to-gray-700/60 hover:from-purple-600/60 hover:to-pink-600/60 backdrop-blur-sm border border-gray-600/40 hover:border-purple-500/50 rounded-xl p-4 mb-3 transition-all duration-300 cursor-pointer shadow-lg hover:shadow-xl transform hover:-translate-y-0.5" onclick="selectProgram('${result.channel_id}')">
                        <div class="flex items-center">
                            ${result.artwork_url ? 
                                `<div class="w-12 h-12 rounded-lg overflow-hidden mr-4 bg-gray-700/50 flex items-center justify-center border border-gray-600/30">
                                    <img src="${result.artwork_url}" alt="${result.title}" class="w-full h-full object-cover">
                                 </div>` :
                                `<div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg flex items-center justify-center mr-4 shadow-lg">
                                    <i class="fas fa-tv text-white"></i>
                                 </div>`
                            }
                            <div class="flex-1">
                                <h4 class="text-white font-semibold group-hover:text-purple-200 transition-colors">${result.title}</h4>
                                <p class="text-gray-400 text-sm group-hover:text-purple-300 transition-colors">${result.channel_name} â€¢ ${result.start_time}</p>
                            </div>
                            <div class="flex items-center space-x-3">
                                <div class="bg-purple-600/20 text-purple-400 px-2 py-1 rounded-full text-xs font-medium border border-purple-500/30">
                                    PROGRAM
                                </div>
                                <i class="fas fa-play text-green-400 group-hover:text-green-300 transition-colors text-lg"></i>
                            </div>
                        </div>
                    </div>
                `;
            }
        }).join('');
        
        searchResults.innerHTML = resultHtml;
    }
    
    function loadRecentChannels() {
        if (!recentChannels) return;
        
        const recent = JSON.parse(localStorage.getItem('recentChannels') || '[]');
        
        if (recent.length === 0) {
            recentChannels.innerHTML = `
                <div class="text-center text-gray-400 col-span-full py-8">
                    <i class="fas fa-tv text-4xl mb-4 opacity-50"></i>
                    <p>No recently watched channels yet</p>
                    <p class="text-sm">Start watching to see your history here</p>
                </div>
            `;
            return;
        }
        
        const recentHtml = recent.slice(0, 6).map(channel => `
            <div class="bg-gray-800/60 backdrop-blur-sm border border-gray-600/40 rounded-xl p-3 hover:bg-gray-700/60 transition-all duration-300 cursor-pointer" onclick="selectChannel('${channel.id}')">
                <div class="text-center">
                    ${channel.logo_url ? 
                        `<img src="${channel.logo_url}" alt="${channel.name}" class="w-12 h-12 rounded mx-auto mb-2 object-contain">` :
                        `<div class="w-12 h-12 bg-blue-500 rounded mx-auto mb-2 flex items-center justify-center">
                            <span class="text-white font-bold text-sm">${channel.name.substr(0, 2)}</span>
                         </div>`
                    }
                    <h4 class="text-white font-medium text-sm truncate">${channel.name}</h4>
                    <p class="text-gray-400 text-xs">${channel.last_watched}</p>
                </div>
            </div>
        `).join('');
        
        recentChannels.innerHTML = recentHtml;
    }
    
    // Global functions for search result clicks
    window.selectChannel = function(channelId) {
        // Navigate to player with this channel
        window.location.href = `/player?channel=${channelId}`;
    };
    
    window.selectProgram = function(channelId) {
        // Navigate to player with this channel
        window.location.href = `/player?channel=${channelId}`;
    };
    
    // Carousel functionality for featured programs
    const cardsContainer = document.getElementById('cards-container');
    const indicatorsContainer = document.getElementById('carousel-indicators');
    const cardTemplate = document.getElementById('card-template');
    
    if (!cardsContainer || !cardTemplate) return;
    
    const allCards = Array.from(cardTemplate.querySelectorAll('.program-card'));
    const totalCards = allCards.length;
    const cardsPerView = 3;
    const totalPages = Math.ceil(totalCards / cardsPerView);
    
    let currentPage = 0;
    
    function showPage(pageIndex) {
        cardsContainer.innerHTML = '';
        const startIndex = pageIndex * cardsPerView;
        const endIndex = Math.min(startIndex + cardsPerView, totalCards);
        
        for (let i = startIndex; i < endIndex; i++) {
            const cardClone = allCards[i].cloneNode(true);
            cardsContainer.appendChild(cardClone);
        }
    }
    
    function updateIndicators() {
        const indicators = indicatorsContainer.children;
        for (let i = 0; i < indicators.length; i++) {
            if (i === currentPage) {
                indicators[i].className = 'w-2 h-2 rounded-full bg-blue-400 transition-all duration-300 cursor-pointer';
            } else {
                indicators[i].className = 'w-2 h-2 rounded-full bg-gray-600 transition-all duration-300 cursor-pointer';
            }
        }
    }
    
    function goToPage(page) {
        currentPage = page;
        showPage(currentPage);
        updateIndicators();
    }
    
    function nextPage() {
        currentPage = (currentPage + 1) % totalPages;
        goToPage(currentPage);
    }
    
    if (totalPages > 1) {
        for (let i = 0; i < totalPages; i++) {
            const indicator = document.createElement('div');
            indicator.className = 'w-2 h-2 rounded-full transition-all duration-300 cursor-pointer';
            indicator.onclick = () => goToPage(i);
            indicatorsContainer.appendChild(indicator);
        }
        setInterval(nextPage, 12000);
    }
    
    goToPage(0);
});</script>
{% endblock %}

