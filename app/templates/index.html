{% extends "base.html" %}

{% block title %}{{ config.get_page_title('home') }}{% endblock %}

{% block content %}
<div class="flex flex-col items-center justify-top text-center">
    <div class="max-w-7xl mx-auto px-8">
        
        {% if user_state == "no_dvr" %}
            <!-- STATE: No DVR Server Found -->
            <div class="mb-8 mt-8">
                <div class="relative">
                    <!-- Warning Background Pattern -->
                    <div class="absolute inset-0 bg-gradient-to-r from-orange-500/20 via-red-500/20 to-pink-500/20 rounded-2xl blur-lg"></div>
                    
                    <!-- Main Warning Card -->
                    <div class="relative bg-gradient-to-br from-gray-800/80 to-gray-900/80 backdrop-blur-xl border-2 border-orange-500/50 rounded-2xl p-8 shadow-2xl shadow-orange-900/30">
                        
                        <!-- Warning Icon -->
                        <div class="flex justify-center mb-6">
                            <div class="w-20 h-20 bg-gradient-to-br from-orange-500 to-red-500 rounded-full flex items-center justify-center shadow-lg shadow-orange-500/30">
                                <i class="fas fa-satellite-dish text-3xl text-white"></i>
                            </div>
                        </div>
                        
                        <!-- Title -->
                        <div class="text-center mb-6">
                            <h2 class="text-3xl font-bold bg-gradient-to-r from-orange-400 via-red-400 to-pink-400 bg-clip-text text-transparent mb-2">
                                Channels DVR Server Not Found
                            </h2>
                            <p class="text-lg text-gray-300">
                                when scanning your network...
                            </p>
                        </div>
                        
                        <!-- Message Content -->
                        <div class="bg-gray-700/50 backdrop-blur-sm border border-gray-600/50 rounded-xl p-6 mb-6">
                            <div class="text-gray-100 space-y-4">
                                <p class="text-gray-300 text-center">
                                    Make sure your Channels DVR server is running and accessible, then refresh this page.
                                </p>
                            </div>
                        </div>
                        
                        <!-- Troubleshooting Section -->
                        <div class="bg-gray-800/60 backdrop-blur-sm border border-gray-600/40 rounded-xl p-6 mb-6">
                            <h3 class="text-white font-semibold mb-4 flex items-center">
                                <i class="fas fa-tools text-orange-400 mr-2"></i>
                                Troubleshooting Tips
                            </h3>
                            <ul class="text-gray-300 text-sm space-y-2">
                                <li class="flex items-start">
                                    <i class="fas fa-check-circle text-orange-400 mr-2 mt-0.5 text-xs"></i>
                                    Auto discovery of Channels DVR is required in this alpha release 
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-check-circle text-orange-400 mr-2 mt-0.5 text-xs"></i>
                                    Check that this device is on the same network as your DVR server
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-check-circle text-orange-400 mr-2 mt-0.5 text-xs"></i>
                                    Verify firewall settings allow mDNS discovery
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-check-circle text-orange-400 mr-2 mt-0.5 text-xs"></i>
                                    Try refreshing the page after a few moments
                                </li>
                            </ul>
                        </div>
                        
                        <!-- Action Button -->
                        <div class="flex justify-center">
                            <button onclick="window.location.reload()" class="group bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 text-white font-bold py-3 px-8 rounded-lg transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                                <i class="fas fa-refresh mr-2 group-hover:animate-spin"></i>
                                Scan Again
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        {% elif user_state == "need_setup" %}
            <!-- STATE: DVR Found, Need Channel Setup -->
            <div class="mb-8 mt-8">
                <div class="relative">
                    <!-- Success Background Pattern -->
                    <div class="absolute inset-0 bg-gradient-to-r from-blue-500/20 via-cyan-500/20 to-teal-500/20 rounded-2xl blur-lg"></div>
                    
                    <!-- Main Success Card -->
                    <div class="relative bg-gradient-to-br from-gray-800/80 to-gray-900/80 backdrop-blur-xl border-2 border-blue-500/50 rounded-2xl p-8 shadow-2xl shadow-blue-900/30">
                        
                        <!-- Success Icon -->
                        <div class="flex justify-center mb-6">
                            <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full flex items-center justify-center shadow-lg shadow-blue-500/30">
                                <i class="fas fa-satellite-dish text-3xl text-white"></i>
                            </div>
                        </div>
                        
                        <!-- Title -->
                        <div class="text-center mb-6">
                            <h2 class="text-3xl font-bold bg-gradient-to-r from-blue-400 via-cyan-400 to-teal-400 bg-clip-text text-transparent mb-2">
                                ðŸš€ Channels DVR Server Connected Successfully
                            </h2>
                            <p class="text-lg text-gray-300">
                                Ready for Channel Setup
                            </p>
                        </div>
                        
                        <!-- Server Info -->
                        <div class="bg-gray-700/50 backdrop-blur-sm border border-gray-600/50 rounded-xl p-6 mb-6">
                            <div class="flex flex-col space-y-4 sm:flex-row sm:items-center sm:justify-between sm:space-y-0 min-w-0">
                                <div class="flex items-center space-x-4 flex-1 min-w-0">
                                    <div class="w-14 h-14 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <i class="fas fa-server text-2xl text-white"></i>
                                    </div>
                                    <div class="min-w-0 flex-1 max-w-md">
                                        <h3 class="text-white font-semibold text-lg mb-1 truncate">{{ server_info.name }}</h3>
                                        <p class="text-gray-400 text-xs break-all">{{ server_info.url }}</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2 bg-green-600/20 backdrop-blur-sm border border-green-500/30 rounded-full px-4 py-2 flex-shrink-0 ml-4">
                                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                    <span class="text-green-400 text-sm font-medium">Online</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Next Steps -->
                        <div class="bg-gray-800/60 backdrop-blur-sm border border-gray-600/40 rounded-xl p-6 mb-6">
                            <h3 class="text-white font-semibold mb-4 flex items-center">
                                <i class="fas fa-list-ol text-blue-400 mr-2"></i>
                                Next Steps
                            </h3>
                            <div class="space-y-3 text-gray-300 text-sm">
                                <div class="flex items-start">
                                    <span class="bg-blue-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center mr-3 mt-0.5">1</span>
                                    <span>Go to Setup to sync channels from your DVR server</span>
                                </div>
                                <div class="flex items-start">
                                    <span class="bg-gray-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center mr-3 mt-0.5">2</span>
                                    <span>Choose which channels you want to use in the app</span>
                                </div>
                                <div class="flex items-start">
                                    <span class="bg-gray-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center mr-3 mt-0.5">3</span>
                                    <span>Create playlists with your selected channels</span>
                                </div>
                                <div class="flex items-start">
                                    <span class="bg-gray-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center mr-3 mt-0.5">4</span>
                                    <span>Start watching live TV!</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Button -->
                        <div class="flex justify-center">
                            <a href="/setup" class="group bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 text-white font-bold py-3 px-8 rounded-lg transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                                <i class="fas fa-cog mr-2"></i>
                                Go to Setup
                            </a>
                        </div>
                    </div>
                </div>
            </div>

        {% elif user_state == "need_playlists" %}
            <!-- STATE: Channels Exist, Need Playlists -->
            <!-- Hero Section -->
            <div class="mb-8 mt-8">
                <div class="relative">
                    <div class="absolute inset-0 bg-gradient-to-r from-blue-600/10 via-purple-600/10 to-green-600/10 rounded-2xl blur-xl"></div>
                    <div class="relative bg-gray-800/40 backdrop-blur-sm border border-gray-600/30 rounded-2xl p-8 shadow-2xl">
                        <div class="flex items-center justify-center mb-2">
                            <div class="w-16 h-16 bg-gradient-to-br from-purple-600 to-purple-700 rounded-full flex items-center justify-center mr-4 shadow-lg">
                                <i class="fas fa-list text-2xl text-white"></i>
                            </div>
                            <div class="text-center">
                                <h1 class="text-4xl font-bold text-white mb-2">Channels Ready</h1>
                                <p class="text-lg text-gray-300">Create Your Playlists</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Playlist Creation Card -->
            <div class="mb-8">
                <div class="relative">
                    <div class="absolute inset-0 bg-gradient-to-r from-purple-500/20 via-violet-500/20 to-blue-500/20 rounded-2xl blur-lg"></div>
                    <div class="relative bg-gradient-to-br from-gray-800/80 to-gray-900/80 backdrop-blur-xl border-2 border-purple-500/50 rounded-2xl p-8 shadow-2xl shadow-purple-900/30">
                        
                        <!-- Playlist Icon -->
                        <div class="flex justify-center mb-6">
                            <div class="w-20 h-20 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center shadow-lg shadow-purple-500/30">
                                <i class="fas fa-heart text-3xl text-white"></i>
                            </div>
                        </div>
                        
                        <!-- Title -->
                        <div class="text-center mb-6">
                            <h2 class="text-3xl font-bold bg-gradient-to-r from-purple-500 via-violet-500 to-blue-500 bg-clip-text text-transparent mb-2">
                                ðŸ“º Create Your Playlists
                            </h2>
                            <p class="text-lg text-gray-300">
                                You have {{ channels_count }} channels ready! Organize them into playlists.
                            </p>
                        </div>
                        
                        <!-- Stats -->
                        <div class="bg-gray-700/50 backdrop-blur-sm border border-gray-600/50 rounded-xl p-6 mb-6">
                            <div class="grid grid-cols-2 gap-6 text-center">
                                <div>
                                    <div class="text-3xl font-bold text-green-400 mb-1">{{ channels_count }}</div>
                                    <div class="text-gray-400 text-sm">Channels Available</div>
                                </div>
                                <div>
                                    <div class="text-3xl font-bold text-purple-400 mb-1">0</div>
                                    <div class="text-gray-400 text-sm">Playlists Created</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Button -->
                        <div class="flex justify-center">
                            <a href="/playlist" class="group bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 text-white font-bold py-3 px-8 rounded-lg transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                                <i class="fas fa-heart mr-2"></i>
                                Create Playlists
                            </a>
                        </div>
                    </div>
                </div>
            </div>

        {% else %}
            <!-- STATE: Ready to Stream -->
            <!-- Hero Section -->
            <div class="mb-8 mt-8">
                <div class="relative">
                    <div class="absolute inset-0 bg-gradient-to-r from-blue-600/10 via-purple-600/10 to-green-600/10 rounded-2xl blur-xl"></div>
                    <div class="relative bg-gray-800/40 backdrop-blur-sm border border-gray-600/30 rounded-2xl p-8 shadow-2xl">
                        <div class="flex items-center justify-center mb-2">
                            <div class="w-16 h-16 bg-gradient-to-br from-red-600 to-red-700 rounded-full flex items-center justify-center mr-4 shadow-lg">
                                <i class="fas fa-play text-2xl text-white"></i>
                            </div>
                            <div class="text-center">
                                <h1 class="text-4xl font-bold text-white mb-2">Now Streaming</h1>
                                <p class="text-lg text-gray-300">Live TV â€¢ From Your Browser</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

                        <!-- Quick Actions -->
            {% if playlists_count > 0 %}
            <div class="mb-8 relative">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <a href="/player" class="group bg-gradient-to-r from-green-600 to-green-700 hover:from-green-500 hover:to-green-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-300 text-center shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                        <i class="fas fa-play text-xl mb-2"></i>
                        <div class="font-bold">Start Watching</div>
                        <div class="text-sm opacity-90">{{ playlists_count }} playlists ready</div>
                    </a>
                    <a href="/playlist" class="group bg-gray-700/60 hover:bg-gray-600/60 border border-gray-600/50 hover:border-gray-500/50 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-300 text-center backdrop-blur-sm transform hover:-translate-y-0.5">
                        <i class="fas fa-list text-xl mb-2"></i>
                        <div class="font-bold">Manage Playlists</div>
                        <div class="text-sm opacity-90">{{ channels_count }} channels available</div>
                    </a>
                    <div class="group bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                        <div class="text-center mb-3">
                            <i class="fas fa-search text-xl mb-2"></i>
                            <div class="font-bold">Search</div>
                        </div>
                        <div class="relative">
                            <input type="text" 
                                   id="directSearchInput" 
                                   placeholder="Type to search..." 
                                   class="w-full bg-white/10 backdrop-blur-sm border border-white/20 rounded-lg px-3 py-2 text-white text-sm placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/30 focus:border-transparent focus:bg-white/15">
                            <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-white/70 text-xs"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Search Results Dropdown -->
                <div id="searchResultsDropdown" class="absolute left-0 right-0 top-full mt-4 hidden z-50">
                    <!-- Background Blur Overlay -->
                    <div class="absolute inset-0 bg-black/20 backdrop-blur-sm rounded-2xl"></div>
                    
                    <!-- Main Content -->
                    <div class="relative bg-gradient-to-br from-gray-800/90 via-gray-700/90 to-gray-900/90 backdrop-blur-xl border-2 border-gray-600/30 rounded-2xl p-6 shadow-2xl shadow-black/30">
                        <!-- Animated Background Pattern -->
                        <div class="absolute inset-0 bg-gradient-to-r from-blue-600/5 via-purple-600/5 to-green-600/5 rounded-2xl blur-xl"></div>
                        
                        <div class="relative">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-bold bg-gradient-to-r from-blue-400 via-purple-400 to-green-400 bg-clip-text text-transparent flex items-center">
                                    <i class="fas fa-search text-blue-400 mr-3 text-xl"></i>
                                    Search Results
                                </h3>
                                <button id="clearSearchBtn" class="group bg-gray-700/60 hover:bg-red-600/60 border border-gray-600/50 hover:border-red-500/50 text-gray-400 hover:text-white px-3 py-2 rounded-lg transition-all duration-300 text-sm backdrop-blur-sm">
                                    <i class="fas fa-times mr-1 group-hover:rotate-90 transition-transform duration-300"></i>Clear
                                </button>
                            </div>
                            
                            <div id="searchResults" class="max-h-96 overflow-y-auto custom-scrollbar">
                                <div class="text-center text-gray-400 py-8">
                                    <i class="fas fa-search text-4xl mb-4 opacity-50"></i>
                                    <p>Start typing to search for channels and programs</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recently Watched Channels -->
            <div class="mb-8">
                <div class="bg-gradient-to-r from-gray-800/30 to-gray-700/30 backdrop-blur-sm border border-gray-600/30 rounded-2xl p-6 shadow-2xl">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-white flex items-center">
                            <i class="fas fa-history text-purple-400 mr-3"></i>
                            Recently Watched
                        </h2>
                        <button id="clearHistoryBtn" class="text-gray-400 hover:text-white text-sm">
                            <i class="fas fa-trash mr-1"></i>Clear History
                        </button>
                    </div>
                    
                    <div id="recentChannels" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        <div class="text-center text-gray-400 col-span-full py-8">
                            <i class="fas fa-tv text-4xl mb-4 opacity-50"></i>
                            <p>No recently watched channels yet</p>
                            <p class="text-sm">Start watching to see your history here</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Starting Soon -->
            {% if starting_soon_programs %}
            <div class="mb-8">
                <div class="bg-gradient-to-r from-gray-800/30 to-gray-700/30 backdrop-blur-sm border border-gray-600/30 rounded-2xl p-6 shadow-2xl">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-white flex items-center">
                            <i class="fas fa-clock text-yellow-400 mr-3"></i>
                            Starting Soon
                            <span class="text-sm font-normal text-gray-400 ml-2">(Next 30 minutes)</span>
                        </h2>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {% for program in starting_soon_programs %}
                        <div class="bg-gray-800/60 backdrop-blur-sm border border-gray-600/40 rounded-xl p-4 hover:bg-gray-700/60 transition-all duration-300">
                            <div class="flex items-center mb-3">
                                {% if program.channel.logo_url %}
                                <img src="{{ program.channel.logo_url }}" alt="{{ program.channel.name }}" class="w-8 h-8 rounded mr-3 object-contain">
                                {% else %}
                                <div class="w-8 h-8 bg-blue-500 rounded flex items-center justify-center mr-3">
                                    <span class="text-white font-bold text-xs">{{ program.channel.name[:2] }}</span>
                                </div>
                                {% endif %}
                                <div class="flex-1 min-w-0">
                                    <h4 class="text-white font-medium text-sm truncate">{{ program.channel.name }}</h4>
                                    <p class="text-yellow-400 text-xs">Starts {{ program.start_time }}</p>
                                </div>
                            </div>
                            
                            <h5 class="text-white font-semibold mb-2 truncate">{{ program.title }}</h5>
                            {% if program.description %}
                            <p class="text-gray-300 text-sm line-clamp-3 mb-3">{{ program.description }}</p>
                            {% endif %}
                            
                            <div class="flex items-center justify-between">
                                <span class="bg-yellow-600/20 text-yellow-400 px-2 py-1 rounded text-xs font-medium">
                                    {{ program.minutes_until }} min
                                </span>
                                <button class="text-blue-400 hover:text-blue-300 text-sm">
                                    <i class="fas fa-bell mr-1"></i>Remind Me
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
            {% endif %}

            <!-- Live Program Cards Section -->
            {% if featured_programs %}
            <div class="bg-gradient-to-r from-gray-800/30 to-gray-700/30 backdrop-blur-sm border border-gray-600/30 rounded-2xl p-8 mb-8 shadow-2xl">

                <div class="relative">
                    <div id="cards-container" class="grid grid-cols-3 gap-6">
                        <!-- Cards will be inserted here by JavaScript -->
                    </div>
                    
                    <!-- Carousel indicators -->
                    <div class="flex justify-center mt-6">
                        <div id="carousel-indicators" class="flex space-x-2">
                            <!-- Indicators will be generated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Hidden template for cards -->
                <div id="card-template" style="display: none;">
                    {% for program_card in featured_programs %}
                    <div class="program-card" data-index="{{ loop.index0 }}">
                        <div class="bg-gray-800/60 backdrop-blur-sm border border-gray-600/40 rounded-xl overflow-hidden hover:bg-gray-700/60 transition-all duration-300 shadow-lg hover:shadow-xl cursor-pointer" onclick="selectChannel('{{ program_card.channel.id }}')">
                            <!-- Channel Header -->
                            <div class="bg-gradient-to-r from-gray-700/80 to-gray-600/80 text-white px-4 py-3 border-b border-gray-600/50">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        {% if program_card.channel.logo_url %}
                                        <img src="{{ program_card.channel.logo_url }}" alt="{{ program_card.channel.name }}" class="w-8 h-8 rounded mr-3 object-contain">
                                        {% else %}
                                        <div class="w-8 h-8 bg-blue-500 rounded flex items-center justify-center mr-3">
                                            <span class="text-white font-bold text-xs">{{ program_card.channel.name[:2] }}</span>
                                        </div>
                                        {% endif %}
                                        <div>
                                            <h3 class="font-semibold text-sm text-white">{{ program_card.channel.name }}</h3>
                                        </div>
                                    </div>
                                    <div class="bg-red-600 text-white px-2 py-1 rounded-full text-xs font-bold animate-pulse">
                                        LIVE
                                    </div>
                                </div>
                            </div>

                            <!-- Program Content -->
                            <div class="p-4">
                                <!-- Program Artwork -->
                                <div class="mb-3 flex justify-center h-32">
                                    {% if program_card.program.artwork_url %}
                                    <img src="{{ program_card.program.artwork_url }}" alt="{{ program_card.program.title }}" class="max-w-full h-full object-contain rounded-lg">
                                    {% endif %}
                                </div>
                                
                                <!-- Title and Time -->
                                <div class="mb-4">
                                    <h4 class="font-bold text-lg text-white mb-1 truncate">{{ program_card.program.title }}</h4>
                                    {% if program_card.start_time and program_card.end_time %}
                                    <p class="text-sm text-blue-300">{{ program_card.start_time }} - {{ program_card.end_time }}</p>
                                    {% endif %}
                                </div>
                                
                                <!-- Progress Bar Area - Always same height -->
                                <div style="height: 3rem;">
                                    {% if program_card.progress > 0 %}
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-xs text-gray-400">Progress</span>
                                        <span class="text-xs text-green-400">{{ program_card.remaining_minutes }} min left</span>
                                    </div>
                                    <div class="w-full bg-gray-700 rounded-full h-2">
                                        <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full transition-all duration-500" style="width: {{ program_card.progress }}%"></div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        {% endif %}

    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
// Initialize page functionality
document.addEventListener('DOMContentLoaded', function() {
    // Initialize search functionality
    new SearchManager();
    
    // Initialize recent channels manager
    new RecentChannelsManager();
    
    // Initialize carousel for featured programs
    new CarouselManager();
});
</script>
{% endblock %}